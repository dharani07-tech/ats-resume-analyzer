<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ATS Score Checker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and modern features -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4F46E5',
                        'secondary': '#8B5CF6',
                        'success': '#10B981',
                        'danger': '#EF4444',
                        'warning': '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .score-display {
            font-size: 3.5rem;
            line-height: 1;
            font-weight: 800;
        }
        textarea {
            resize: vertical;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4F46E5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                AI ATS Score & Resume Match Checker
            </h1>
            <p class="text-lg text-gray-600">
                Analyze your resume against a Job Description to get an ATS Match Score and an AI critique.
            </p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Panel -->
            <div class="lg:col-span-2 container-card bg-white p-6 rounded-xl shadow-lg h-full">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Inputs</h2>
                
                <!-- Resume Input -->
                <div class="mb-6">
                    <label for="resumeText" class="block text-sm font-medium text-gray-700 mb-1">Paste Your Resume Content</label>
                    <textarea id="resumeText" rows="10" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150"
                        placeholder="Paste the plain text of your resume here (e.g., Name, Experience, Skills, Education...)"></textarea>
                </div>

                <!-- JD Input -->
                <div class="mb-6">
                    <label for="jdText" class="block text-sm font-medium text-gray-700 mb-1">Paste the Job Description (JD)</label>
                    <textarea id="jdText" rows="6" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150"
                        placeholder="Paste the full job description text here (e.g., Requirements, Responsibilities, Qualifications...)"></textarea>
                </div>

                <button id="analyzeButton" onclick="runAnalysisPipeline()" 
                    class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-secondary focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 transition duration-300 shadow-md flex items-center justify-center">
                    <span id="buttonText">Get ATS Score & AI Critique</span>
                    <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                </button>
            </div>

            <!-- Results Panel -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Score Card -->
                <div class="container-card bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ATS Match Score</h2>
                    <div id="scoreDisplay" class="score-display text-center text-primary">0%</div>
                    <p id="scoreMessage" class="text-center text-gray-600 mt-2">Enter text and analyze to see the fit.</p>
                </div>

                <!-- Match Details -->
                <div class="container-card bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Match Details</h2>
                    <div class="space-y-4 text-sm">
                        <div>
                            <p class="font-medium text-success mb-1">‚úÖ Matched Skills:</p>
                            <div id="matchedSkills" class="text-gray-600 p-2 bg-green-50 rounded-lg">None</div>
                        </div>
                        <div>
                            <p class="font-medium text-danger mb-1">‚ùå Missing Skills (Gaps):</p>
                            <div id="missingSkills" class="text-gray-600 p-2 bg-red-50 rounded-lg">None</div>
                        </div>
                        <div>
                            <p class="font-medium text-warning mb-1">‚è≥ Estimated YOE:</p>
                            <div id="estimatedYOE" class="text-gray-600 p-2 bg-yellow-50 rounded-lg">N/A</div>
                        </div>
                    </div>
                </div>

                <!-- AI Critique -->
                <div class="container-card bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ü§ñ AI Professional Critique</h2>
                    <div id="aiCritique" class="text-gray-700 italic leading-relaxed min-h-24">
                        The AI will analyze the match and provide a summary of strengths and weaknesses here.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- The single file JavaScript logic starts here -->
    <script>
        // --- STEP 1: DEFINE DOMAIN KNOWLEDGE ---
        // A consolidated list of common skills for matching (the ATS "dictionary").
        const DOMAIN_SKILLS = new Set([
            "PYTHON", "DJANGO", "FLASK", "JAVASCRIPT", "JS", "TYPESCRIPT", "REACT", "ANGULAR", 
            "NODE.JS", "POSTGRESQL", "MONGODB", "MYSQL", "SQL", "AWS", "AZURE", "GCP", 
            "DOCKER", "KUBERNETES", "TERRAFORM", "GIT", "JIRA", "AGILE", "TDD", 
            "MICROSERVICES", "REST", "API", "CLOUD", "C++", "JAVA", "RUST", "GOLANG"
        ]);

        // Define critical, high-weight keywords often required by companies
        const CRITICAL_KEYWORDS = new Set(["PYTHON", "JAVASCRIPT", "REACT", "AWS", "KUBERNETES", "DJANGO", "FLASK"]);
        
        // --- STEP 2: UTILITY FUNCTIONS ---

        /**
         * Removes special characters and normalizes text for reliable matching.
         * @param {string} text - The input resume or JD text.
         * @returns {string} - Cleaned and normalized text (uppercase).
         */
        function cleanAndNormalize(text) {
            if (!text) return "";
            // Remove punctuation and convert to space, standardize whitespace, and convert to uppercase
            let cleaned = text.replace(/[^a-zA-Z0-9\s]/g, ' ');
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            return cleaned.toUpperCase();
        }

        /**
         * Estimates Years of Experience (YOE) by looking for common patterns (Simplified).
         * NOTE: A production ATS would use precise date parsing from the experience section.
         * @param {string} text - The resume content.
         * @returns {number} - Estimated total years of experience.
         */
        function estimateYOE(text) {
            // Regex to find year ranges (2018-2022) or explicit YOE (5 Years)
            const yearRangeMatches = Array.from(text.matchAll(/(\d{4})\s*-\s*(PRESENT|\d{4})/gi));
            let totalExperienceMonths = 0;
            const currentYear = new Date().getFullYear();

            yearRangeMatches.forEach(match => {
                const startYear = parseInt(match[1]);
                const endYear = match[2].toUpperCase() === 'PRESENT' ? currentYear : parseInt(match[2]);
                
                if (endYear > startYear) {
                    totalExperienceMonths += (endYear - startYear) * 12;
                }
            });

            // Use a fallback for explicit YOE mentions (less reliable)
            const explicitYOEMatches = text.match(/(\d+)\s+year[s]?/gi);
            if (explicitYOEMatches && totalExperienceMonths === 0) {
                 // If no date ranges, sum the max explicit year found (imperfect)
                 const years = explicitYOEMatches.map(m => parseInt(m)).filter(n => !isNaN(n));
                 totalExperienceMonths = (years.length > 0 ? Math.max(...years) : 0) * 12;
            }
            
            // Return max of 1 year if some text exists but parsing failed, to avoid 0% in all cases
            return Math.ceil((totalExperienceMonths / 12) || (text.length > 100 ? 1 : 0));
        }

        /**
         * ATS Scoring logic based on keyword matching and weighting.
         * @param {string} resumeText - Normalized resume text.
         * @param {string} jdText - Normalized JD text.
         * @returns {object} - Analysis results including score and matched skills.
         */
        function calculateATSScore(resumeText, jdText) {
            const requiredSkills = new Set();
            const candidateSkills = new Set();
            
            // Identify skills required by JD
            DOMAIN_SKILLS.forEach(skill => {
                if (jdText.includes(skill)) {
                    requiredSkills.add(skill);
                }
            });
            
            // Identify skills the candidate possesses
            DOMAIN_SKILLS.forEach(skill => {
                if (resumeText.includes(skill)) {
                    candidateSkills.add(skill);
                }
            });

            const matchedSkills = [...candidateSkills].filter(skill => requiredSkills.has(skill));

            if (requiredSkills.size === 0) {
                return { score: 0, matched: [], missing: [] };
            }

            // --- Weighted Scoring Calculation ---
            
            // 1. Skill Coverage (70% weight)
            const skillCoverage = matchedSkills.length / requiredSkills.size;
            
            // 2. Critical Keyword Match (30% weight)
            const criticalRequired = [...requiredSkills].filter(skill => CRITICAL_KEYWORDS.has(skill));
            const criticalMatched = matchedSkills.filter(skill => CRITICAL_KEYWORDS.has(skill));
            
            let criticalWeight = 0;
            if (criticalRequired.length > 0) {
                criticalWeight = criticalMatched.length / criticalRequired.length;
            }
            
            // Final Score = (Coverage * 0.7) + (Critical Match * 0.3)
            let finalScore = (skillCoverage * 0.7) + (criticalWeight * 0.3);
            finalScore = Math.min(100, Math.round(finalScore * 100)); // Cap at 100%

            const missingSkills = [...requiredSkills].filter(skill => !candidateSkills.has(skill));

            return {
                score: finalScore,
                matched: matchedSkills.sort(),
                missing: missingSkills.sort(),
                required: [...requiredSkills].sort()
            };
        }

        // --- STEP 3: AI CRITIQUE GENERATION (Gemini API Call) ---

        const apiKey = ""; // API Key is provided by the canvas environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        async function getAICritique(resumeContent, jdContent, score, matched, missing) {
            const systemPrompt = `Act as a world-class HR Recruiter and ATS expert. Your task is to provide a concise (max 4 sentences), professional critique of the candidate's fit based on the ATS match. Highlight the top strength and the biggest gap based on the score and missing skills.`;
            
            const userQuery = `Analyze the following:
ATS Match Score: ${score}%
Matched Skills: ${matched.join(', ')}
Missing Skills: ${missing.join(', ')}

--- Resume Content ---
${resumeContent.substring(0, 1000)}...

--- Job Description ---
${jdContent.substring(0, 500)}...

Critique the candidate's suitability for the role.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                // Implement exponential backoff for API robustness
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "AI response failed to generate.";
                        return text;
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        console.warn(`Rate limit hit. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                }
                return "Failed to get AI critique after multiple retries.";

            } catch (error) {
                console.error("AI Critique Error:", error);
                return "Error fetching AI critique. Please check console for details.";
            }
        }


        // --- STEP 4: UI/EVENT HANDLER ---

        /**
         * Main pipeline function triggered by the button click.
         */
        async function runAnalysisPipeline() {
            const resumeInput = document.getElementById('resumeText').value;
            const jdInput = document.getElementById('jdText').value;
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');

            if (!resumeInput || !jdInput) {
                alert("Please paste content into both the Resume and Job Description fields.");
                return;
            }

            // Reset UI and show loading state
            analyzeButton.disabled = true;
            buttonText.textContent = "Analyzing...";
            loadingSpinner.classList.remove('hidden');
            document.getElementById('scoreDisplay').textContent = '...%';
            document.getElementById('scoreMessage').textContent = 'Calculating score and generating AI critique...';
            document.getElementById('aiCritique').innerHTML = '<div class="spinner mx-auto"></div>';
            document.getElementById('matchedSkills').textContent = 'Processing...';
            document.getElementById('missingSkills').textContent = 'Processing...';
            document.getElementById('estimatedYOE').textContent = 'Processing...';


            // 1. Data Cleaning
            const cleanResume = cleanAndNormalize(resumeInput);
            const cleanJD = cleanAndNormalize(jdInput);

            // 2. Quantitative ATS Scoring
            const analysisResults = calculateATSScore(cleanResume, cleanJD);
            const yoe = estimateYOE(resumeInput);

            // 3. Update UI with Quantitative Results
            const score = analysisResults.score;
            document.getElementById('scoreDisplay').textContent = `${score}%`;
            document.getElementById('matchedSkills').textContent = analysisResults.matched.length > 0 ? analysisResults.matched.join(', ') : 'No direct matches found.';
            document.getElementById('missingSkills').textContent = analysisResults.missing.length > 0 ? analysisResults.missing.join(', ') : 'All required skills matched!';
            document.getElementById('estimatedYOE').textContent = `${yoe} years`;

            let scoreMsg;
            let scoreColor;

            if (score >= 75) {
                scoreMsg = "Excellent Fit! Strong recommendation for interview.";
                scoreColor = 'text-success';
            } else if (score >= 50) {
                scoreMsg = "Good Fit. Meets most primary requirements.";
                scoreColor = 'text-warning';
            } else {
                scoreMsg = "Low Fit. Significant skill gaps identified.";
                scoreColor = 'text-danger';
            }
            
            document.getElementById('scoreDisplay').className = `score-display text-center ${scoreColor}`;
            document.getElementById('scoreMessage').textContent = scoreMsg;

            // 4. Qualitative AI Critique
            const critique = await getAICritique(
                resumeInput, 
                jdInput, 
                score, 
                analysisResults.matched, 
                analysisResults.missing
            );
            
            document.getElementById('aiCritique').textContent = critique;


            // Reset button state
            analyzeButton.disabled = false;
            buttonText.textContent = "Get ATS Score & AI Critique";
            loadingSpinner.classList.add('hidden');
        }
    </script>
</body>
</html>
